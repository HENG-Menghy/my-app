// learn more about it in the docs: https://pris.ly/d/prisma-schema
// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
enum UserRole {
  user
  admin
}

enum UserGender {
  male
  female
}

enum UserStatus {
  pending
  active
  suspended
}

enum RoomStatus {
  active
  inactive
}

enum RoomType {
  meeting
  conference
}

enum BookingStatus {
  pending
  approved
  rejected
  cancelled
  requested_cancellation
}

enum RecurrencePattern {
  daily
  weekly
  monthly
}

enum WeekDay {
  sunday
  monday
  tuesday
  wednesday
  thursday
  friday
  saturday
}

enum MeetingStatus {
  ongoing
  in_progress
  modified
  completed
  cancelled
}

enum MeetingHistoryAction {
  created
  modified
  reassigned
  overridden
  ended
  cancelled
}

enum AuthEventType {
  REGISTER
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
  PASSWORD_RESET
  ACCOUNT_LOCKED
  TOKEN_REFRESH
  TOKEN_REUSED
  SESSION_EXPIRED
}

enum AuthEventStatus {
  success
  failure
}

model User {
  id String @id @default(uuid())
  email String @unique @db.VarChar(255)
  password String @db.VarChar(255)
  phonenumber String @unique @db.VarChar(255)
  fullname String @db.VarChar(255)
  role UserRole @default(user)
  gender UserGender
  imageUrl String?
  status UserStatus @default(pending)
  emailVerified DateTime?
  lastLoginAt DateTime?
  passwordChangedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookings   Booking[]  @relation(name: "UserBookings")
  approvedBy Booking[]  @relation(name: "ApprovedByUser")
  bookedBy   Booking[]  @relation(name: "BookedByUser")
  assignedTo Booking[]  @relation(name: "AssignedToUser")
  recurrenceBookings RecurrenceBooking[] 

  assignedMeetings  Meeting[]  @relation(name: "AssignedMeetings")
  modifiedMeetings  Meeting[]  @relation(name: "ModifiedMeetings")
  meetingHistories MeetingHistory[] 

  notifications Notification[]
  reports Report[]

  authEvents AuthEvent[]
  sessions Session[]
}

model AuthEvent {
  id String @id @default(uuid())
  userId String 
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  type AuthEventType
  status AuthEventStatus @default(success) 
  sessions Session[]
  createdAt DateTime @default(now())
}

model Session {
  id String @id @default(uuid())
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId String
  authEvent AuthEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  invalidated Boolean @default(false)
  metadata Json
  expiresAt DateTime?
  lastActiveAt DateTime @default(now())
  createdAt DateTime @default(now())
}

model Booking {
  id String @id @default(uuid())
  roomId String
  room Room @relation(fields: [roomId], references: [id])
  userId String
  user User @relation(name: "UserBookings", fields: [userId], references: [id])
  bookedBy String
  bookedByUser User @relation(name: "BookedByUser", fields: [bookedBy], references: [id])
  approvedBy String?
  approvedByUser User? @relation(name: "ApprovedByUser", fields: [approvedBy], references: [id])
  assignedTo String?
  assignedToUser User? @relation(name: "AssignedToUser", fields: [assignedTo], references: [id])
  recurrenceId String?
  recurrence RecurrenceBooking? @relation(fields: [recurrenceId], references: [id])
  code String @unique @db.VarChar(255)
  meetingTitle String 
  meetingLeader String @db.VarChar(255)
  startDateTime DateTime // Store date + time together
  endDateTime DateTime  // Store date + time together
  status BookingStatus @default(pending)
  isDeleted Boolean @default(false)
  cancellationReason String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  meeting Meeting? @relation(name: "BookingId")
  reference Meeting? @relation(name: "referenceCode")
  notifications Notification[]
  reports Report[]
}

model RecurrenceBooking {
  id String @id @default(uuid())
  roomId String
  room Room @relation(fields: [roomId], references: [id])
  createdBy String
  user User @relation(fields: [createdBy], references: [id])
  meetingTitle String
  meetingLeader String @db.VarChar(255)
  pattern RecurrencePattern
  interval Int
  weekdays WeekDay[]
  dayOfMonth Int[]
  startDate DateTime
  endDate DateTime
  startTime String
  endTime String
  isActive Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookings Booking[]
}

model Meeting {
  id String @id @default(uuid())
  bookingId String @unique
  booking Booking @relation(name: "BookingId", fields: [bookingId], references: [id])
  assignedTo String?
  assignedMeetingTo User? @relation(name: "AssignedMeetings", fields: [assignedTo], references: [id])
  modifiedBy String?
  modifiedMeetingBy User? @relation(name: "ModifiedMeetings", fields: [modifiedBy], references: [id])
  bookingReference String @unique @db.VarChar(255)
  reference Booking @relation(name: "referenceCode", fields: [bookingReference], references: [code])
  status MeetingStatus 
  isDeleted Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  histories  MeetingHistory[]
  notifications Notification[]
  reports Report[]
}

model MeetingHistory {
  id String @id @default(uuid())
  meetingId String
  meeting Meeting @relation(fields: [meetingId], references: [id])
  modifiedBy String?
  user User? @relation(fields: [modifiedBy], references: [id])
  description String?
  action MeetingHistoryAction
  modifiedAt DateTime @default(now())
}

model Building {
  id String @id @default(uuid())
  name String @unique @db.VarChar(255)
  address String
  totalFloors Int
  totalRooms Int? @default(0)
  hasGroundFloor Boolean @default(false)
  description String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  floors Floor[]
}

model Floor {
  id String @id @default(uuid())
  buildingId String 
  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  floorNumber Int 
  totalRooms Int @default(0)
  name String? @unique @db.VarChar(255)
  label String? @db.VarChar(255)
  description String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  rooms Room[]

  @@unique([buildingId, floorNumber]) // Only unique per building
  @@unique([buildingId, label]) // Only unique per building
}

model Room {
  id String @id @default(uuid())
  floorId String
  floor Floor @relation(fields: [floorId], references: [id], onDelete: Cascade)
  imageUrl String?
  name String @unique @db.VarChar(255)
  type RoomType @default(meeting)
  status RoomStatus @default(active)
  capacity Int
  amenities String[]
  availableHours Json

  overrides RoomAvailabilityOverride[]
  bookings Booking[]
  recurrenceBookings RecurrenceBooking[]
  
  description String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RoomAvailabilityGroup {
  id String @id @default(uuid())  
  date DateTime
  isClosed Boolean
  reason String?
  rooms RoomAvailabilityOverride[]
  createdAt DateTime @default(now())
}

model RoomAvailabilityOverride {
  id String @id @default(uuid())
  roomId String
  room Room @relation(fields: [roomId], references: [id])
  groupId String
  group RoomAvailabilityGroup @relation(fields: [groupId], references: [id])

  @@unique([roomId, groupId])
}

model Holiday {
  id     String @id @default(uuid())
  date   DateTime @unique
  name   String
}

model Notification {
  id String @id @default(uuid())
  userId String
  user User @relation(fields: [userId], references: [id])
  bookingId String?
  booking Booking? @relation(fields: [bookingId], references: [id]) 
  meetingId String?
  meeting Meeting? @relation(fields: [meetingId], references: [id])
  message String
  type String @db.VarChar(255)
  isRead Boolean @default(false)
  createdAt DateTime @default(now())
}

model Report {
  id String @id @default(uuid())
  generatedBy String
  user User @relation(fields: [generatedBy], references: [id])
  bookingId String?
  booking Booking? @relation(fields: [bookingId], references: [id]) 
  meetingId String?
  meeting Meeting? @relation(fields: [meetingId], references: [id])
  data Json
  type String @db.VarChar(255)
  createdAt DateTime @default(now())
}